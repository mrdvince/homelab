name: Claude Code Review

on:
  pull_request:
    types: [opened, synchronize, ready_for_review, reopened]
    paths-ignore:
      - '.github/workflows/**'

jobs:
  code-review:
    if: github.event.pull_request.user.login != 'renovate[bot]'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
      issues: read
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Run Claude Code Review
        id: claude-review
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          plugin_marketplaces: 'https://github.com/anthropics/claude-code.git'
          plugins: 'code-review@claude-code-plugins'
          prompt: '/code-review:code-review ${{ github.repository }}/pull/${{ github.event.pull_request.number }}'

  dependency-review:
    if: |
      github.event.pull_request.user.login == 'renovate[bot]' &&
      contains(toJson(github.event.pull_request.labels.*.name), 'major-update')
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: read
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Review major dependency update
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          allowed_bots: 'renovate[bot]'
          allowed_tools: 'Bash,Read,Grep,Glob,WebFetch,mcp__github__create_or_update_file,mcp__github__create_pull_request_review,mcp__github__add_issue_comment,mcp__github__get_pull_request,mcp__github__get_pull_request_diff,mcp__github__get_pull_request_files'
          prompt: |
            Review this major dependency update PR: ${{ github.repository }}/pull/${{ github.event.pull_request.number }}
            
            IMPORTANT! you are running in headless/non-interactive so do not ask user questions, just make decisions and proceed

            Steps:
            1. Use gh to get the PR diff and identify what's being updated (package name, old version, new version)
            2. Determine the package type (container image, helm chart, github action)
            3. Find and fetch the changelog or release notes:
               - For container images: check the project's GitHub releases or CHANGELOG
               - For helm charts: check the chart's GitHub releases or artifacthub.io
               - For github actions: check the action's GitHub releases
            4. Identify breaking changes between the old and new versions
            5. Assess impact on this homelab setup by checking how the dependency is used in the codebase

            Post a PR comment with (don't ask just do it if it fails due to a tool mention it and exit):
            - Summary of what's being updated
            - Key changes and new features
            - Breaking changes (if any)
            - Migration steps needed (if any)
            - Recommendation: safe to merge, needs manual testing, or needs code changes

            Use WebFetch to get changelogs/release notes. Use gh CLI for GitHub API calls.
            Be concise but thorough. Focus on actionable information.

            Rules:
            - NO explanations of what the software is or does - assume reader knows
            - NO generic descriptions of what major updates typically include
            - ONLY specific breaking changes from the actual changelog
            - Keep it short, concise and actionable
            - Use plain markdown, no emojis