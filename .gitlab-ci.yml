stages:
  - test
  - generate
  - trigger
  - publish

include:
  - template: Jobs/Secret-Detection.gitlab-ci.yml
  - template: Jobs/SAST.gitlab-ci.yml
  - local: infrastructure/images/templates/sync.yml
  - local: infrastructure/images/templates/build.yml

variables:
  SECRET_DETECTION_DISABLED: "false"
  SAST_DISABLED: "false"
  SCAN_KUBERNETES_MANIFESTS: "true"

generate-images-pipeline:
  stage: generate
  image: registry.home.mrdvince.me/library/alpine:latest
  before_script:
    - apk add --no-cache yq
  script:
    - |
      cd infrastructure/images
      cat > child-pipeline.yml << 'HEADER'
      include:
        - local: infrastructure/images/templates/sync.yml

      stages:
        - sync
      HEADER

      for file in images/*.yaml; do
        name=$(basename "${file}" .yaml)
        cat >> child-pipeline.yml << EOF

      sync-${name}:
        stage: sync
        extends: .sync-images
        variables:
          IMAGE_FILE: "infrastructure/images/${file}"
        rules:
          - if: \$PARENT_PIPELINE_SOURCE == "web" || \$PARENT_PIPELINE_SOURCE == "schedule"
          - if: \$SYNC_ALL == "true"
          - changes:
              - infrastructure/images/${file}
              - infrastructure/images/templates/sync.yml
      EOF
      done

      for file in builds/*.yaml; do
        [ -f "$file" ] || continue
        name=$(basename "${file}" .yaml)
        cat >> child-pipeline.yml << EOF

      build-${name}:
        stage: sync
        extends: .build-images
        variables:
          BUILD_FILE: "infrastructure/images/${file}"
        rules:
          - if: \$PARENT_PIPELINE_SOURCE == "web" || \$PARENT_PIPELINE_SOURCE == "schedule"
          - if: \$BUILD_ALL == "true"
          - changes:
              - infrastructure/images/${file}
              - infrastructure/images/templates/build.yml
      EOF
      done

      echo "Generated child pipeline:"
      cat child-pipeline.yml
      mv child-pipeline.yml ../../
  artifacts:
    paths:
      - child-pipeline.yml
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      changes:
        - infrastructure/images/images/**/*.yaml
        - infrastructure/images/builds/**/*.yaml
        - infrastructure/images/templates/**/*.yml
    - if: $CI_PIPELINE_SOURCE == "web"
    - if: $CI_PIPELINE_SOURCE == "schedule"

trigger-images-sync:
  stage: trigger
  variables:
    PARENT_PIPELINE_SOURCE: $CI_PIPELINE_SOURCE
  trigger:
    include:
      - artifact: child-pipeline.yml
        job: generate-images-pipeline
    strategy: depend
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      changes:
        - infrastructure/images/images/**/*.yaml
        - infrastructure/images/builds/**/*.yaml
        - infrastructure/images/templates/**/*.yml
    - if: $CI_PIPELINE_SOURCE == "web"
    - if: $CI_PIPELINE_SOURCE == "schedule"

publish-charts:
  stage: publish
  needs: []
  image: registry.home.mrdvince.me/library/alpine:latest
  variables:
    HELM_VERSION: "3.16.4"
  before_script:
    - apk add --no-cache curl
    - |
      curl -fsSL "https://get.helm.sh/helm-v${HELM_VERSION}-linux-amd64.tar.gz" | tar xz
      mv linux-amd64/helm /usr/local/bin/
  script:
    - |
      for chart in charts/*/Chart.yaml; do
        dir=$(dirname "$chart")
        name=$(grep '^name:' "$chart" | awk '{print $2}')
        version=$(grep '^version:' "$chart" | awk '{print $2}')
        echo "Packaging ${name}..."
        helm dependency update "$dir"
        helm package "$dir" --destination .

        tgz="${name}-${version}.tgz"
        if [ ! -f "$tgz" ]; then
          echo "Failed to package ${name}"
          exit 1
        fi

        echo "Pushing ${tgz} to Helm registry..."
        curl --fail-with-body --user "gitlab-ci-token:${CI_JOB_TOKEN}" \
          --form "chart=@${tgz}" \
          "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/helm/api/stable/charts"

        rm -f "$tgz"
      done
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      changes:
        - charts/**/*