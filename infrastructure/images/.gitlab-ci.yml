stages:
  - generate
  - trigger

generate-pipeline:
  stage: generate
  image: alpine:latest
  before_script:
    - apk add --no-cache yq
  script:
    - |
      cat > child-pipeline.yml << 'HEADER'
      include:
        - local: templates/sync.yml

      stages:
        - sync
      HEADER

      for file in images/*.yaml; do
        name=$(basename "${file}" .yaml)
        cat >> child-pipeline.yml << EOF

      sync-${name}:
        stage: sync
        extends: .sync-images
        variables:
          IMAGE_FILE: "${file}"
        rules:
          - if: \$PARENT_PIPELINE_SOURCE == "web" || \$PARENT_PIPELINE_SOURCE == "schedule"
          - if: \$SYNC_ALL == "true"
          - changes:
              - ${file}
              - templates/sync.yml
      EOF
      done

      echo "Generated child pipeline:"
      cat child-pipeline.yml
  artifacts:
    paths:
      - child-pipeline.yml
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      changes:
        - images/**/*.yaml
        - templates/**/*.yml
    - if: $CI_PIPELINE_SOURCE == "web"
    - if: $CI_PIPELINE_SOURCE == "schedule"

trigger-sync:
  stage: trigger
  variables:
    PARENT_PIPELINE_SOURCE: $CI_PIPELINE_SOURCE
  trigger:
    include:
      - artifact: child-pipeline.yml
        job: generate-pipeline
    strategy: depend
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      changes:
        - images/**/*.yaml
        - templates/**/*.yml
    - if: $CI_PIPELINE_SOURCE == "web"
    - if: $CI_PIPELINE_SOURCE == "schedule"
